var userDashboardConfig=window.__USER_DASHBOARD_CONFIG||{};!function(){var e=document.getElementById("toastMessage"),t=document.getElementById("attendanceModal"),n=t?t.querySelector("[data-modal-close]"):null,a=document.getElementById("closeAttendanceModal"),i=document.querySelectorAll("[data-attendance-open]"),r=document.getElementById("requestModal"),o=r?r.querySelector("[data-request-close]"):null,s=document.getElementById("closeRequestModal"),u=document.querySelectorAll("[data-request-type]"),l=document.getElementById("loanModal"),d=l?l.querySelector("[data-loan-close]"):null,c=document.getElementById("closeLoanModal"),m=document.querySelectorAll("[data-loan-open]"),g=document.getElementById("leaveRequestForm"),f=document.getElementById("requestTypeInput"),h=document.getElementById("requestTypeLabel"),p=document.getElementById("izinTypeWrap"),v=document.getElementById("izinTypeInput"),b=document.getElementById("requestStartDate"),y=document.getElementById("requestEndDate"),E=document.getElementById("requestReason"),I=document.getElementById("requestReasonLabel"),k=document.getElementById("requestSupportFile"),C=document.getElementById("requestSupportLabel"),w=document.getElementById("requestSupportHint"),x=document.getElementById("submitLeaveRequestButton"),S=document.getElementById("loanRequestForm"),L=document.getElementById("loanAmount"),B=document.getElementById("loanTenor"),P=document.querySelectorAll("[data-loan-tenor]"),M=document.getElementById("toggleMoreTenorButton"),j=document.getElementById("tenorMoreWrap"),D=document.getElementById("loanReason"),A=document.getElementById("loanDetailCard"),F=document.getElementById("loanDetailContent"),T=document.getElementById("loanNominalValue"),q=document.getElementById("loanTenorValue"),R=document.getElementById("loanStatusValue"),N=document.getElementById("loanRateValue"),_=document.getElementById("loanInterestValue"),z=document.getElementById("loanMonthlyInstallmentValue"),G=document.getElementById("loanTotalValue"),O=document.getElementById("submitLoanRequestButton"),V=document.getElementById("cameraPreview"),H=document.getElementById("cameraPlaceholder"),J=document.getElementById("cameraSelect"),W=document.getElementById("capturePhotoButton"),K=document.getElementById("captureCanvas"),U=document.getElementById("attendanceTypeSelect"),X=document.getElementById("gpsValue"),Y=document.getElementById("timeValue"),Z=document.getElementById("shiftValue"),Q=document.getElementById("lateReasonWrap"),$=document.getElementById("lateReasonInput"),ee=document.getElementById("captureResult"),te=document.getElementById("capturedImage"),ne=document.getElementById("resultMeta"),ae=document.getElementById("summaryStatusPill"),ie=document.getElementById("summaryJamMasuk"),re=document.getElementById("summaryJamPulang"),oe=document.getElementById("summaryTargetPulang"),se=document.getElementById("summaryHadirBulan"),ue=document.getElementById("summaryTerlambatBulan"),le=document.getElementById("summaryIzinBulan"),de=document.getElementById("historyTableBody"),ce=document.getElementById("loanHistoryTableBody"),me=String(userDashboardConfig.submitEndpoint||""),ge=String(userDashboardConfig.leaveRequestEndpoint||""),fe=String(userDashboardConfig.loanRequestEndpoint||""),he=String(userDashboardConfig.dashboardSummaryEndpoint||""),pe=userDashboardConfig.loanConfig&&"object"==typeof userDashboardConfig.loanConfig?userDashboardConfig.loanConfig:{minPrincipal:5e5,maxPrincipal:1e7,minTenorMonths:1,maxTenorMonths:12,isFirstLoan:!0},ve=String(userDashboardConfig.shiftTimeText||""),be=Number(userDashboardConfig.officeLat),ye=Number(userDashboardConfig.officeLng),Ee=Number(userDashboardConfig.officeRadiusM),Ie=Number(userDashboardConfig.maxAccuracyM),ke=x?x.textContent:"Kirim Pengajuan",Ce=O?O.textContent:"Kirim Pengajuan Pinjaman",we={pdf:!0,png:!0,jpg:!0,heic:!0};if(e&&t&&r&&i.length){for(var xe=null,Se=null,Le="",Be="",Pe=null,Me=!1,je=null,De=null,Ae=!1,Fe=null,officePointList=function(){for(var e=Array.isArray(userDashboardConfig.officePoints)?userDashboardConfig.officePoints:[],t=[],n=0;n<e.length;n+=1){var a=e[n]&&"object"==typeof e[n]?e[n]:{},i=Number(a.lat),r=Number(a.lng),o=String(a.label||"Kantor");isFinite(i)&&isFinite(r)&&t.push({lat:i,lng:r,label:o})}return t.length||t.push({lat:be,lng:ye,label:"Kantor"}),t}(),Te=function(t){e.textContent=t,e.classList.add("show"),Fe&&window.clearTimeout(Fe),Fe=window.setTimeout(function(){e.classList.remove("show")},7000)},qe=function(e){var t=parseInt(String(e||"0"),10);return!isFinite(t)||t<0?0:t},Re=function(e){var t=document.createElement("td");return t.textContent=String(e||"-"),t},Ne=function(e){var t=String(e||"").toLowerCase();return-1!==t.indexOf("terima")?"diterima":-1!==t.indexOf("tolak")?"ditolak":"menunggu"},_e=function(e){return Ae?Promise.resolve(null):(Ae=!0,fetch(he,{method:"GET",headers:{"X-Requested-With":"XMLHttpRequest","Cache-Control":"no-cache"},cache:"no-store"}).then(function(e){return e.json().then(function(t){if(!e.ok||!t||!0!==t.success)throw new Error(t&&t.message?t.message:"Gagal memuat data dashboard.");return t})}).then(function(e){var t,n;return t=e.summary||{},n=t&&"object"==typeof t?t:{},ae&&(ae.textContent=String(n.status_hari_ini||"Siap Absen")),ie&&(ie.textContent=String(n.jam_masuk||"-")),re&&(re.textContent=String(n.jam_pulang||"-")),oe&&(oe.textContent=String(n.target_pulang||"17:00")),se&&(se.textContent=String(qe(n.total_hadir_bulan_ini))),ue&&(ue.textContent=String(qe(n.total_terlambat_bulan_ini))),le&&(le.textContent=String(qe(n.total_izin_bulan_ini))),function(e){if(de){if(de.innerHTML="",!Array.isArray(e)||0===e.length){var t=document.createElement("tr"),n=document.createElement("td");return n.colSpan=6,n.textContent="Belum ada riwayat absensi.",t.appendChild(n),void de.appendChild(t)}for(var a=0;a<e.length;a+=1){var i=e[a]&&"object"==typeof e[a]?e[a]:{},r=document.createElement("tr");r.appendChild(Re(i.tanggal||"-")),r.appendChild(Re(i.masuk||"-")),r.appendChild(Re(i.pulang||"-"));var o=document.createElement("td"),s=document.createElement("span"),u=String(i.status||"-"),l=u.toLowerCase();s.className="badge "+(-1!==l.indexOf("terlambat")?"terlambat":"hadir"),s.textContent=u,o.appendChild(s),r.appendChild(o),r.appendChild(Re(i.catatan||"-")),r.appendChild(Re(i.potongan||"-")),de.appendChild(r)}}}(e.recent_logs||[]),function(e){if(ce){if(ce.innerHTML="",!Array.isArray(e)||0===e.length){var t=document.createElement("tr"),n=document.createElement("td");return n.colSpan=5,n.textContent="Belum ada riwayat pinjaman.",t.appendChild(n),void ce.appendChild(t)}for(var a=0;a<e.length;a+=1){var i=e[a]&&"object"==typeof e[a]?e[a]:{},r=document.createElement("tr");r.appendChild(Re(i.tanggal||"-")),r.appendChild(Re(i.nominal||"Rp 0")),r.appendChild(Re(i.tenor||"-")),r.appendChild(Re(i.cicilan_bulanan||"Rp 0"));var o=document.createElement("td"),s=document.createElement("span"),u=String(i.status||"Menunggu");s.className="badge "+Ne(u),s.textContent=u,o.appendChild(s),r.appendChild(o),ce.appendChild(r)}}}(e.recent_loans||[]),Ae=!1,e}).catch(function(t){return Ae=!1,!0!==e&&Te(t.message||"Gagal memuat data dashboard."),null}))},ze=function(){null!==De&&(window.clearInterval(De),De=null),Ae=!1},Ge=function(){if(W){var e="masuk"===Le||"pulang"===Le,t=!!xe&&!!Se&&!0===Se.geofenceInside&&e;W.disabled=!t}},Oe=function(){var e=t&&t.classList.contains("show"),n=r&&r.classList.contains("show"),a=l&&l.classList.contains("show");document.body.style.overflow=e||n||a?"hidden":""},Ve=function(e){if(e)return t.classList.add("show"),t.setAttribute("aria-hidden","false"),void Oe();t.classList.remove("show"),t.setAttribute("aria-hidden","true"),Oe()},He=function(e){if(e)return r.classList.add("show"),r.setAttribute("aria-hidden","false"),void Oe();r.classList.remove("show"),r.setAttribute("aria-hidden","true"),Oe()},Je=function(e){if(l){if(e)return l.classList.add("show"),l.setAttribute("aria-hidden","false"),void Oe();l.classList.remove("show"),l.setAttribute("aria-hidden","true"),Oe()}},We=function(e){var t=String(e||"").toLowerCase();"masuk"!==t&&"pulang"!==t&&(t=""),Le=t,U&&(""===t?U.selectedIndex=-1:U.value=t),rt(),Ge()},Ke=function(){var e=f?String(f.value||"").toLowerCase():"",t=v?String(v.value||"").toLowerCase():"",n="izin"===e,a=n&&"sakit"===t,i="Bukti (Opsional)",r="Format yang diizinkan: .pdf, .png, .jpg, .heic",o=n?"Alasan Izin":"Alasan Cuti";p&&p.classList.toggle("is-hidden",!n),v&&(v.required=n),I&&(I.textContent=o),a?(i="Surat Izin Sakit (Wajib)",r="Wajib upload surat izin sakit. Format: .pdf, .png, .jpg, .heic"):n&&"darurat"===t&&(i="Bukti Darurat (Opsional)",r="Bukti darurat opsional. Format: .pdf, .png, .jpg, .heic"),C&&(C.textContent=i),w&&(w.textContent=r),k&&(k.required=a)},Ue=function(e){return String(e||"").replace(/\D+/g,"")},Xe=function(e){if(L){var t,n,a=!!e,i=pe&&isFinite(Number(pe.minPrincipal))?Number(pe.minPrincipal):5e5,r=pe&&isFinite(Number(pe.maxPrincipal))?Number(pe.maxPrincipal):1e7,o=function(e){var t=parseInt(Ue(e),10);return!isFinite(t)||t<0?0:t}(L.value);if(o<=0)L.value="";else o>r&&(o=r),a&&o<i&&(o=i),L.value=(t=String(o),""===(n=Ue(t))?"":n.replace(/\B(?=(\d{3})+(?!\d))/g,"."))}},Ye=function(e){var t=Number(e||0);return isFinite(t)||(t=0),"Rp "+Math.round(t).toLocaleString("id-ID")},Ze=function(e){var t=parseInt(String(e||""),10);return isFinite(t)?t:0},Qe=function(e){if(j){var t=!!e;j.classList.toggle("is-hidden",!t),M&&(M.hidden=t,M.setAttribute("aria-hidden",t?"true":"false"),t||(M.textContent="Lihat lainnya..."))}},$e=function(e){var t=Ze(e);if(B){B.value=t<1||t>12?"":String(t);for(var n=0;n<P.length;n+=1){var a=P[n],i=Ze(a.getAttribute("data-loan-tenor")),r=t>0&&i===t;a.classList.toggle("is-active",r),a.setAttribute("aria-pressed",r?"true":"false")}t>=5&&Qe(!0),et()}},et=function(){if(A&&F){var e=pe&&isFinite(Number(pe.minPrincipal))?Number(pe.minPrincipal):5e5,t=pe&&isFinite(Number(pe.maxPrincipal))?Number(pe.maxPrincipal):1e7,n=pe&&isFinite(Number(pe.minTenorMonths))?Number(pe.minTenorMonths):1,a=pe&&isFinite(Number(pe.maxTenorMonths))?Number(pe.maxTenorMonths):12,i=!(!pe||!pe.isFirstLoan),r=L?Ue(L.value):"",o=""===r?0:parseInt(r,10),s=B?Ze(B.value):0;if(o<e||o>t||s<n||s>a)return A.hidden=!0,void(F.hidden=!0);var u=function(e,t,n){if(!isFinite(e)||e<=0||!isFinite(t)||t<=0)return null;for(var a=n?0:2.95,i=Math.round(e*a/100),r=i*t,o=e+r,s=Math.round(o/t),u=Math.floor(o/t),l=o-u*t,d=[],c=1;c<=t;c+=1){var m=u;c===t&&l>0&&(m+=l),d.push({month:c,amount:m})}return{principal:e,tenorMonths:t,isFirstLoan:!!n,monthlyRatePercent:a,monthlyInterestAmount:i,totalInterestAmount:r,totalPayment:o,monthlyInstallmentEstimate:s,installments:d}}(o,s,i);if(!u)return A.hidden=!0,void(F.hidden=!0);A.hidden=!1,F.hidden=!1,T&&(T.textContent=Ye(u.principal)),q&&(q.textContent=u.tenorMonths+" bulan"),R&&(R.textContent=u.isFirstLoan?"Pinjaman pertama akun (0% bunga)":"Pinjaman lanjutan akun (bunga berlaku)"),N&&(N.textContent=u.monthlyRatePercent.toFixed(2).replace(".",",")+"% per bulan"),_&&(_.textContent=Ye(u.monthlyInterestAmount)),z&&(z.textContent=Ye(u.monthlyInstallmentEstimate)),G&&(G.textContent=Ye(u.totalPayment))}},tt=function(){A&&(A.hidden=!0),F&&(F.hidden=!0),T&&(T.textContent="Rp 0"),q&&(q.textContent="0 bulan"),R&&(R.textContent="-"),N&&(N.textContent="0,00% per bulan"),_&&(_.textContent="Rp 0"),z&&(z.textContent="Rp 0"),G&&(G.textContent="Rp 0")},nt=function(){return new Intl.DateTimeFormat("id-ID",{weekday:"long",day:"2-digit",month:"long",year:"numeric",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).format(new Date)},at=function(e,t,n){var a=String(n||"").toLowerCase(),i=-1!==a.indexOf("kantor 2")?125:Ie;return e<=Ee&&t<=i?{inside:!0,label:"Valid (akurasi baik)",message:""}:e+t<=Ee?{inside:!0,label:"Valid (toleransi akurasi)",message:""}:e-t>Ee?{inside:!1,label:"Di luar radius",message:"Lokasi di luar radius kantor. Jarak kamu "+e.toFixed(2)+"m (maks "+Ee+"m)."}:{inside:!1,label:"Akurasi belum cukup",message:"Posisi GPS belum cukup akurat (jarak "+e.toFixed(2)+"m, akurasi "+Math.round(t)+"m). Coba aktifkan lokasi akurat lalu ulangi."}},it=function(){if("masuk"!==Le)return 0;var e=0;try{for(var t=new Intl.DateTimeFormat("en-GB",{timeZone:"Asia/Jakarta",hour:"2-digit",minute:"2-digit",second:"2-digit",hour12:!1}).formatToParts(new Date),n=0,a=0,i=0,r=0;r<t.length;r+=1)"hour"===t[r].type?n=parseInt(t[r].value,10):"minute"===t[r].type?a=parseInt(t[r].value,10):"second"===t[r].type&&(i=parseInt(t[r].value,10));e=3600*n+60*a+i}catch(t){var o=new Date;e=3600*o.getHours()+60*o.getMinutes()+o.getSeconds()}var s=String(ve||"").toLowerCase(),u=-1!==s.indexOf("23:59")||-1!==s.indexOf("23:00"),l=-1!==s.indexOf("14:00")||-1!==s.indexOf("12:00"),d=28800;if(u){var c=46800,m=50400;if(e>=c&&e<=m)return 0;d=e>m?m:28800}else l&&(d=50400);return e<=d+59?0:e-d},rt=function(){if(Q&&$){var e=it(),t="masuk"===Le&&e>0;Q.classList.toggle("show",t),$.required=t,t||($.value="")}},ot=function(){if(xe){for(var e=xe.getTracks(),t=0;t<e.length;t+=1)e[t].stop();xe=null,V.srcObject=null,Ge()}},st=function(){null!==Pe&&(window.clearInterval(Pe),Pe=null),Me=!1},ut=function(){null!==je&&(window.clearInterval(je),je=null)},lt=function(e,t){H&&(H.textContent=e,H.style.display=t?"flex":"none")},dt=function(e){if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia)return Promise.reject(new Error("Browser tidak mendukung akses kamera."));ot(),lt("Meminta akses kamera...",!0),W.disabled=!0;var t={video:e?{deviceId:{exact:e}}:{facingMode:"user"},audio:!1};return navigator.mediaDevices.getUserMedia(t).then(function(e){xe=e,V.srcObject=e,V.style.transform="scaleX(-1)",lt("Kamera aktif.",!1),Ge();var t=e.getVideoTracks();return t.length&&t[0].getSettings().deviceId&&(Be=t[0].getSettings().deviceId),navigator.mediaDevices&&navigator.mediaDevices.enumerateDevices&&J?navigator.mediaDevices.enumerateDevices().then(function(e){var t=e.filter(function(e){return"videoinput"===e.kind});if(J.innerHTML="",!t.length){var n=document.createElement("option");return n.value="",n.textContent="Kamera tidak ditemukan",void J.appendChild(n)}for(var a=0;a<t.length;a+=1){var i=document.createElement("option");i.value=t[a].deviceId,i.textContent=t[a].label||"Camera "+(a+1),J.appendChild(i)}""!==Be?J.value=Be:Be=J.value}):Promise.resolve()})},ct=function(e){for(var t=e.coords.latitude,n=e.coords.longitude,a=e.coords.accuracy,i=function(e,t,n,a){var i=(n-e)*(Math.PI/180),r=(a-t)*(Math.PI/180),o=e*(Math.PI/180),s=n*(Math.PI/180),u=Math.sin(i/2)*Math.sin(i/2)+Math.cos(o)*Math.cos(s)*Math.sin(r/2)*Math.sin(r/2),l=2*Math.atan2(Math.sqrt(u),Math.sqrt(1-u));return 6371e3*l},r=1/0,o="titik kantor",p=Array.isArray(window.__USER_DASHBOARD_CONFIG&&window.__USER_DASHBOARD_CONFIG.officePoints)?window.__USER_DASHBOARD_CONFIG.officePoints:officePointList,s=0;s<p.length;s+=1){var u=p[s]&&"object"==typeof p[s]?p[s]:{},l=Number(u.lat),d=Number(u.lng);if(isFinite(l)&&isFinite(d)){var c=i(t,n,l,d);c<r&&(r=c,o=String(u.label||"").trim()!==""?String(u.label):"titik kantor")}}isFinite(r)||(r=i(t,n,be,ye),o="titik kantor");var m=at(r,a,o);return Se={lat:t,lng:n,accuracy:a,distance:r,officeLabel:o,geofenceInside:m.inside,geofenceMessage:m.message},X.textContent=Se.lat.toFixed(6)+", "+Se.lng.toFixed(6)+" | Jarak "+r.toFixed(2)+"m dari "+o+" | Akurasi "+Math.round(Se.accuracy)+"m | "+m.label,Ge(),m},mt=function(){return navigator.geolocation?Me?Promise.resolve(null):(Me=!0,new Promise(function(e,t){navigator.geolocation.getCurrentPosition(function(t){Me=!1,e(ct(t))},function(e){Me=!1,Se=null,Ge();var n=function(e){return e&&"number"==typeof e.code?e.code===e.TIMEOUT?"Permintaan GPS timeout.":e.code===e.POSITION_UNAVAILABLE?"Lokasi tidak tersedia.":e.code===e.PERMISSION_DENIED?"Izin lokasi ditolak.":"Gagal membaca GPS.":"Gagal membaca GPS."}(e);X.textContent=n,t(new Error(n))},{enableHighAccuracy:!0,timeout:1e4,maximumAge:0})})):Promise.reject(new Error("Browser tidak mendukung GPS."))},gt=function(){r.classList.contains("show")&&He(!1),l&&l.classList.contains("show")&&Je(!1),Se=null,We(""),ee&&ee.classList.remove("show"),te&&(te.src=""),ne&&(ne.textContent=""),X.textContent="Meminta lokasi...",Y.textContent="-",Ve(!0),ut(),Y.textContent=nt(),rt(),je=window.setInterval(function(){Y.textContent=nt(),rt()},1e3),Promise.allSettled([navigator.geolocation?(st(),Se=null,Ge(),X.textContent="Memulai GPS realtime (refresh tiap "+String(Math.round(3))+" detik)...",new Promise(function(e,t){var n=!1;mt().then(function(){n||(n=!0,e())}).catch(function(e){n||(n=!0,t(e))}),Pe=window.setInterval(function(){mt().catch(function(){})},3e3)})):Promise.reject(new Error("Browser tidak mendukung GPS.")),dt(Be)]).then(function(e){"rejected"===e[0].status?(W.disabled=!0,Te(e[0].reason.message)):Se&&!0!==Se.geofenceInside&&Se.geofenceMessage&&Te(Se.geofenceMessage),"rejected"===e[1].status&&(lt(e[1].reason.message,!0),Te(e[1].reason.message)),Ge()})},ft=function(){st(),ut(),ot(),lt("Meminta akses kamera...",!0),W.disabled=!0,Ve(!1)},ht=function(e){var n=String(e||"").toLowerCase();if("cuti"===n||"izin"===n){t.classList.contains("show")&&ft(),l&&l.classList.contains("show")&&vt();var a,i=(a=new Date).getFullYear()+"-"+String(a.getMonth()+1).padStart(2,"0")+"-"+String(a.getDate()).padStart(2,"0");f&&(f.value=n),h&&(h.textContent=function(e){return"cuti"===e?"Cuti":"Izin"}(n)),v&&(v.selectedIndex=-1),b&&(b.value=i),y&&(y.value=i),E&&(E.value=""),k&&(k.value=""),Ke(),x&&(x.disabled=!1,x.textContent=ke),He(!0),"izin"===n&&v?v.focus():E&&E.focus()}else Te("Jenis pengajuan tidak valid.")},pt=function(){g&&g.reset(),f&&(f.value=""),h&&(h.textContent="-"),v&&(v.selectedIndex=-1),k&&(k.value=""),Ke(),x&&(x.disabled=!1,x.textContent=ke),He(!1)},vt=function(){S&&S.reset(),L&&(L.value=""),B&&(B.value=""),Qe(!1),$e(""),D&&(D.value=""),tt(),O&&(O.disabled=!1,O.textContent=Ce),Je(!1)},bt=0;bt<i.length;bt+=1)i[bt].addEventListener("click",function(){gt()});for(var yt=0;yt<u.length;yt+=1)u[yt].addEventListener("click",function(){ht(this.getAttribute("data-request-type"))});for(var Et=0;Et<m.length;Et+=1)m[Et].addEventListener("click",function(){t.classList.contains("show")&&ft(),r.classList.contains("show")&&pt(),L&&(L.value=""),B&&(B.value=""),Qe(!1),$e(""),D&&(D.value=""),tt(),O&&(O.disabled=!1,O.textContent=Ce),et(),Je(!0),L&&L.focus()});n&&n.addEventListener("click",ft),a&&a.addEventListener("click",ft),o&&o.addEventListener("click",pt),s&&s.addEventListener("click",pt),d&&d.addEventListener("click",vt),c&&c.addEventListener("click",vt),J&&J.addEventListener("change",function(){Be=J.value,dt(Be).catch(function(e){lt(e.message,!0),Te(e.message)})}),U&&U.addEventListener("change",function(){We(U.value)}),$&&$.addEventListener("input",function(){Ge()}),L&&(L.addEventListener("input",function(){Xe(!1),et()}),L.addEventListener("blur",function(){Xe(!0),et()})),M&&M.addEventListener("click",function(){var e=!j||j.classList.contains("is-hidden");Qe(e)});for(var It=0;It<P.length;It+=1)(function(e){e.addEventListener("click",function(){$e(e.getAttribute("data-loan-tenor"))})})(P[It]);v&&v.addEventListener("change",function(){Ke()}),W&&W.addEventListener("click",function(){if("masuk"!==Le&&"pulang"!==Le)return Te("Pilih jenis absensi (masuk/pulang) terlebih dahulu."),void(U&&U.focus());if(xe)if(Se){var e=at(Se.distance,Se.accuracy,Se.officeLabel||"");if(e.inside){var t=it(),n=$?$.value.trim():"";if("masuk"===Le&&t>0&&""===n)return Te("Kamu telat masuk. Alasan keterlambatan wajib diisi."),void($&&$.focus());if(V.videoWidth&&V.videoHeight){var a=V.videoWidth,i=V.videoHeight,r=Math.max(a,i),o=a,s=i,u=(r-o)/2,l=(r-s)/2;K.width=r,K.height=r;var d=K.getContext("2d");d.fillStyle="#132b4a",d.fillRect(0,0,r,r),d.save(),d.translate(u+o,l),d.scale(-1,1),d.drawImage(V,0,0,a,i,0,0,o,s),d.restore();var c=K.toDataURL("image/jpeg",.92);te.src=c,ee.classList.add("show"),ee&&"function"==typeof ee.scrollIntoView&&window.requestAnimationFrame(function(){ee.scrollIntoView({behavior:"smooth",block:"center"})});var m,g=Z?Z.textContent:"-";ne.textContent=("masuk"===(m=Le)?"Absen Masuk":"pulang"===m?"Absen Pulang":"-")+" | "+g+" | Jarak "+Se.distance.toFixed(2)+"m | "+Se.lat.toFixed(6)+", "+Se.lng.toFixed(6)+" | "+nt(),function(e){if("masuk"!==Le&&"pulang"!==Le)return Promise.reject(new Error("Pilih jenis absensi (masuk/pulang) terlebih dahulu."));var t=new FormData,n=$?$.value.trim():"";return t.append("action",Le),t.append("photo",e),t.append("latitude",String(Se.lat)),t.append("longitude",String(Se.lng)),t.append("accuracy",String(Se.accuracy)),t.append("late_reason",n),fetch(me,{method:"POST",body:t}).then(function(e){return e.json().then(function(t){if(!e.ok||!t.success)throw new Error(t.message||"Gagal menyimpan absensi.");return t})})}(c).then(function(e){ne.textContent=ne.textContent+" | Tersimpan",_e(!0),Te(e.message||"Absensi berhasil disimpan.")}).catch(function(e){Te(e.message)})}else Te("Preview kamera belum siap.")}else Te(e.message)}else Te("Lokasi GPS belum tersedia. Izinkan akses lokasi terlebih dahulu.");else Te("Kamera belum aktif. Izinkan akses kamera terlebih dahulu.")}),g&&g.addEventListener("submit",function(e){e.preventDefault();var t=f?String(f.value||"").toLowerCase():"",n=v?String(v.value||"").toLowerCase():"",a=b?String(b.value||""):"",i=y?String(y.value||""):"",r=E?E.value.trim():"",o=k&&k.files&&k.files.length?k.files[0]:null;if("cuti"===t||"izin"===t){if("izin"===t&&"sakit"!==n&&"darurat"!==n)return Te("Pilih jenis izin terlebih dahulu."),void(v&&v.focus());if(""!==a&&""!==i)if(i<a)Te("Tanggal selesai tidak boleh lebih kecil dari tanggal mulai.");else{if(""===r)return Te("Alasan pengajuan wajib diisi."),void(E&&E.focus());if(o){var s=(u=o.name,l=String(u||"").toLowerCase().trim(),(d=l.lastIndexOf("."))<=0||d===l.length-1?"":l.slice(d+1));if(!we[s])return void Te("Format bukti harus .pdf, .png, .jpg, atau .heic.")}var u,l,d;if("izin"===t&&"sakit"===n&&!o)return Te("Surat izin sakit wajib diupload."),void(k&&k.focus());var c=new FormData;c.append("request_type",t),c.append("izin_type",n),c.append("start_date",a),c.append("end_date",i),c.append("reason",r),o&&c.append("support_file",o),x&&(x.disabled=!0,x.textContent="Mengirim..."),function(e){return fetch(ge,{method:"POST",body:e}).then(function(e){return e.json().then(function(t){if(!e.ok||!t.success)throw new Error(t.message||"Gagal mengirim pengajuan.");return t})})}(c).then(function(e){Te(e.message||"Pengajuan berhasil dikirim."),pt()}).catch(function(e){Te(e.message),x&&(x.disabled=!1,x.textContent=ke)})}else Te("Tanggal mulai dan selesai wajib diisi.")}else Te("Jenis pengajuan tidak valid.")}),S&&S.addEventListener("submit",function(e){e.preventDefault(),Xe(!0);var t=L?Ue(L.value):"",n=""===t?0:parseInt(t,10),a=B?Ze(B.value):0,i=D?D.value.trim():"",r=pe&&isFinite(Number(pe.minPrincipal))?Number(pe.minPrincipal):5e5,o=pe&&isFinite(Number(pe.maxPrincipal))?Number(pe.maxPrincipal):1e7;if(n<r||n>o)return Te("Nominal pinjaman harus antara Rp 500.000 sampai Rp 10.000.000."),void(L&&L.focus());if(a<1||a>12)return Te("Tenor pinjaman harus antara 1 sampai 12 bulan."),void(P.length>0?P[0].focus():M&&M.focus());if(""===i)return Te("Alasan pinjaman wajib diisi."),void(D&&D.focus());var s=new FormData;s.append("amount",String(n)),s.append("tenor_months",String(a)),s.append("reason",i),O&&(O.disabled=!0,O.textContent="Mengirim..."),function(e){return fetch(fe,{method:"POST",body:e}).then(function(e){return e.json().then(function(t){if(!e.ok||!t.success)throw new Error(t.message||"Gagal mengirim pengajuan pinjaman.");return t})})}(s).then(function(e){pe&&(pe.isFirstLoan=!1),Te(e.message||"Pengajuan pinjaman berhasil dikirim."),vt()}).catch(function(e){Te(e.message),O&&(O.disabled=!1,O.textContent=Ce)})}),ze(),_e(!0),De=window.setInterval(function(){_e(!0)},3e4),document.addEventListener("keydown",function(e){"Escape"===e.key&&(r.classList.contains("show")&&pt(),l&&l.classList.contains("show")&&vt(),t.classList.contains("show")&&ft())}),window.addEventListener("beforeunload",function(){ze(),st(),ut(),ot()})}}();